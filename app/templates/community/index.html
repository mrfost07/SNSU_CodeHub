{% extends "base.html" %}

{% block title %}Community{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row g-4">
        <!-- Left Sidebar -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
                <div class="card-body">
                    <h5 class="card-title mb-3">My Communities</h5>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                            <span class="badge bg-primary rounded-circle p-2"><i class="fas fa-code"></i></span>
                            BSIT Community
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                            <span class="badge bg-primary rounded-circle p-2"><i class="fas fa-code"></i></span>
                            Python Developers
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center gap-2">
                            <span class="badge bg-primary rounded-circle p-2"><i class="fas fa-code"></i></span>
                            Web Dev Club
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Post Creation -->
        <div class="col-md-6">
            <div class="card hover-card mb-4">
                <div class="card-body">
                    <form action="{{ url_for('community.create_post') }}" method="POST" enctype="multipart/form-data" 
                          class="post-form" id="createPostForm">
                        <div class="mb-3">
                            <textarea class="form-control input-modern" name="content" rows="3" 
                                    placeholder="Share your thoughts..." data-emojiable="true"></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <label class="btn btn-modern btn-sm">
                                    <i class="fas fa-image"></i>
                                    <input type="file" name="media" hidden accept="image/*,video/*" 
                                           onchange="previewMedia(this)">
                                </label>
                                <button type="button" class="btn btn-modern btn-sm" onclick="toggleCodeEditor()">
                                    <i class="fas fa-code"></i>
                                </button>
                                <button type="button" class="btn btn-modern btn-sm" onclick="togglePoll()">
                                    <i class="fas fa-poll"></i>
                                </button>
                            </div>
                            <button type="submit" class="btn btn-modern">Share <i class="fas fa-paper-plane ms-2"></i></button>
                        </div>
                        <div id="mediaPreview" class="mt-3"></div>
                        <div id="codeEditor" class="mt-3 d-none">
                            <select class="form-select mb-2" id="languageSelect">
                                <option value="javascript">JavaScript</option>
                                <option value="python">Python</option>
                                <option value="java">Java</option>
                            </select>
                            <textarea id="codeArea" class="form-control" rows="5"></textarea>
                        </div>
                        <div id="pollCreator" class="mt-3 d-none">
                            <input type="text" class="form-control mb-2" placeholder="Poll question">
                            <div id="pollOptions">
                                <input type="text" class="form-control mb-2" placeholder="Option 1">
                                <input type="text" class="form-control mb-2" placeholder="Option 2">
                            </div>
                            <button type="button" class="btn btn-sm btn-modern" onclick="addPollOption()">
                                Add Option
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Enhanced Posts Display -->
            {% for post in posts %}
            <div class="card hover-card mb-4 post-card" data-aos="fade-up">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <img src="{{ url_for('static', filename='img/default-avatar.png') }}" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                        <div>
                            <h6 class="mb-0">{{ post.author.username }}</h6>
                            <small class="text-muted">{{ post.created_at.strftime('%B %d, %Y %H:%M') }}</small>
                        </div>
                    </div>

                    {% if post.content_type == 'code' %}
                    <pre class="code-block language-{{ post.language }}"><code>{{ post.content }}</code></pre>
                    {% elif post.content_type == 'poll' %}
                    <div class="poll-container">
                        <h6>{{ post.poll_question }}</h6>
                        {% for option in post.poll_options %}
                        <div class="poll-option">
                            <div class="progress mb-2">
                                <div class="progress-bar" style="width: {{ option.percentage }}%">
                                    {{ option.text }} ({{ option.votes }})
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    {{ post.content }}
                    {% endif %}

                    {% if post.media_url %}
                    <div class="media-container mb-3">
                        {% if post.content_type == 'image' %}
                        <img src="{{ post.media_url }}" class="img-fluid rounded" alt="Post image">
                        {% elif post.content_type == 'video' %}
                        <video class="w-100 rounded" controls>
                            <source src="{{ post.media_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Enhanced Interaction Buttons -->
                    <div class="d-flex gap-3 mt-3">
                        <button class="btn btn-modern btn-sm reaction-btn" data-reaction="like">
                            <i class="fas fa-heart"></i> <span>{{ post.likes|length }}</span>
                        </button>
                        <button class="btn btn-modern btn-sm" onclick="toggleComments({{ post.id }})">
                            <i class="fas fa-comment"></i> <span>{{ post.comments.count() }}</span>
                        </button>
                        <button class="btn btn-modern btn-sm share-btn">
                            <i class="fas fa-share"></i> <span>{{ post.shares.count() }}</span>
                        </button>
                        <div class="dropdown ms-auto">
                            <button class="btn btn-modern btn-sm" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="savePost({{ post.id }})">
                                    <i class="fas fa-bookmark"></i> Save
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="reportPost({{ post.id }})">
                                    <i class="fas fa-flag"></i> Report
                                </a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Enhanced Comments Section -->
                    <div id="comments-{{ post.id }}" class="comment-wrapper mt-3" style="display: none;">
                        <form action="{{ url_for('community.add_comment', post_id=post.id) }}" method="POST">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" name="content" placeholder="Write a comment...">
                                <button class="btn btn-primary" type="submit">Comment</button>
                            </div>
                        </form>
                        {% for comment in post.comments %}
                        <div class="d-flex gap-2 mb-2">
                            <img src="{{ url_for('static', filename='img/default-avatar.png') }}" class="rounded-circle" style="width: 32px; height: 32px;">
                            <div class="bg-light rounded p-2 flex-grow-1">
                                <small class="fw-bold">{{ comment.author.username }}</small>
                                <p class="mb-0">{{ comment.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Right Sidebar -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
                <div class="card-body">
                    <h5 class="card-title mb-3">Trending Topics</h5>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action">#Python</a>
                        <a href="#" class="list-group-item list-group-item-action">#WebDev</a>
                        <a href="#" class="list-group-item list-group-item-action">#JavaScript</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript -->
<script>
function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
}

function previewMedia(input) {
    const preview = document.getElementById('media-preview');
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            if (file.type.startsWith('image/')) {
                preview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded mt-2" style="max-height: 200px;">`;
            } else if (file.type.startsWith('video/')) {
                preview.innerHTML = `<video class="w-100 rounded mt-2" style="max-height: 200px;" controls>
                    <source src="${e.target.result}" type="video/mp4">
                </video>`;
            }
        }
        reader.readAsDataURL(file);
    }
}

// Enhanced like functionality with animation
document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const postId = button.dataset.postId;
        const response = await fetch(`/community/post/${postId}/like`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();
        button.querySelector('.like-count').textContent = data.likes;
        button.classList.toggle('btn-outline-primary');
        button.classList.toggle('btn-primary');
        
        if (data.action === 'liked') {
            button.querySelector('i').classList.add('animate__animated', 'animate__heartBeat');
        }
    });
});

// Share functionality
document.querySelectorAll('.share-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const postId = button.dataset.postId;
        const response = await fetch(`/community/post/${postId}/share`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();
        button.querySelector('.share-count').textContent = data.shares;
        showToast(data.message, 'success');
    });
});

// Enhance the existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Add parallax effect to post cards
    window.addEventListener('scroll', () => {
        document.querySelectorAll('.post-card').forEach(card => {
            const rect = card.getBoundingClientRect();
            const offset = Math.min(Math.max(0, window.innerHeight - rect.top) / 5, 20);
            card.style.transform = `translateY(${offset}px)`;
        });
    });

    // Add like animation
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.add('animate__animated', 'animate__rubberBand');
            setTimeout(() => this.classList.remove('animate__animated', 'animate__rubberBand'), 1000);
        });
    });
});

function toggleCodeEditor() {
    const codeEditor = document.getElementById('codeEditor');
    codeEditor.classList.toggle('d-none');
    if (!codeEditor.classList.contains('d-none')) {
        initCodeMirror();
    }
}

function togglePoll() {
    const pollCreator = document.getElementById('pollCreator');
    pollCreator.classList.toggle('d-none');
}

function addPollOption() {
    const pollOptions = document.getElementById('pollOptions');
    const newOption = document.createElement('input');
    newOption.type = 'text';
    newOption.className = 'form-control mb-2';
    newOption.placeholder = `Option ${pollOptions.children.length + 1}`;
    pollOptions.appendChild(newOption);
}

// Add these new interactive features
document.addEventListener('DOMContentLoaded', function() {
    // Initialize emoji picker
    new EmojiPicker({
        trigger: [
            {
                selector: '.post-form textarea',
                insertInto: '.post-form textarea',
            },
        ],
        closeButton: true,
    });

    // Initialize code highlighting
    Prism.highlightAll();

    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
});
</script>
{% endblock %}
